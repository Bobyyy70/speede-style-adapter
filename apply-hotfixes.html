<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Appliquer les Hotfixes - WMS SendCloud</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .container {
      background: white;
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      max-width: 600px;
      width: 100%;
      padding: 40px;
    }
    h1 {
      color: #2d3748;
      margin-bottom: 10px;
      font-size: 24px;
    }
    .subtitle {
      color: #718096;
      margin-bottom: 30px;
      font-size: 14px;
    }
    .info-box {
      background: #edf2f7;
      border-left: 4px solid #4299e1;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 4px;
    }
    .info-box h3 {
      color: #2c5282;
      font-size: 14px;
      margin-bottom: 8px;
    }
    .info-box ul {
      list-style: none;
      padding-left: 0;
    }
    .info-box li {
      color: #4a5568;
      font-size: 13px;
      padding: 4px 0;
      padding-left: 20px;
      position: relative;
    }
    .info-box li:before {
      content: "‚úì";
      position: absolute;
      left: 0;
      color: #48bb78;
      font-weight: bold;
    }
    button {
      width: 100%;
      padding: 16px;
      font-size: 16px;
      font-weight: 600;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      margin-bottom: 12px;
    }
    button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    .btn-secondary {
      background: #48bb78;
      color: white;
    }
    .btn-single {
      background: #ed8936;
      color: white;
      font-size: 14px;
      padding: 12px;
    }
    #result {
      margin-top: 20px;
      padding: 16px;
      border-radius: 8px;
      font-size: 14px;
      line-height: 1.6;
      display: none;
    }
    #result.success {
      background: #c6f6d5;
      border: 1px solid #48bb78;
      color: #22543d;
      display: block;
    }
    #result.error {
      background: #fed7d7;
      border: 1px solid #f56565;
      color: #742a2a;
      display: block;
    }
    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
      margin-right: 8px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .section {
      margin: 30px 0;
      padding: 20px;
      background: #f7fafc;
      border-radius: 8px;
    }
    .section h3 {
      color: #2d3748;
      font-size: 16px;
      margin-bottom: 12px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîß Appliquer les Hotfixes</h1>
    <p class="subtitle">Syst√®me WMS SendCloud - Corrections critiques</p>

    <div class="info-box">
      <h3>Hotfixes disponibles:</h3>
      <ul>
        <li>HOTFIX 005: Statuts manquants dans CHECK constraint</li>
        <li>HOTFIX 006: RLS policies NULL-safe pour client_id</li>
      </ul>
    </div>

    <button class="btn-primary" onclick="applyAllHotfixes()">
      üöÄ Appliquer TOUS les hotfixes
    </button>

    <div class="section">
      <h3>Appliquer individuellement:</h3>
      <button class="btn-single" onclick="applyHotfix('005')">
        Hotfix 005 uniquement
      </button>
      <button class="btn-single" onclick="applyHotfix('006')">
        Hotfix 006 uniquement
      </button>
    </div>

    <div id="result"></div>
  </div>

  <script type="module">
    // Configuration Supabase depuis .env
    const SUPABASE_URL = 'https://tggdjeoxvpzbigbikpfy.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRnZ2RqZW94dnB6YmlnYmlrcGZ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyMzY3MjYsImV4cCI6MjA3NDgxMjcyNn0.f9yoHVsRDvlUHv14N46qNFphPDBFMf0C0XzEoo26AWA';

    window.applyAllHotfixes = async function() {
      const btn = event.target;
      const result = document.getElementById('result');

      btn.disabled = true;
      btn.innerHTML = '<span class="loading"></span> Application en cours...';
      result.style.display = 'none';

      try {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/rpc/apply_all_hotfixes`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'apikey': SUPABASE_KEY,
            'Authorization': `Bearer ${SUPABASE_KEY}`,
            'Prefer': 'return=representation'
          }
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.message || 'Erreur HTTP ' + response.status);
        }

        const data = await response.json();

        result.className = 'success';
        result.innerHTML = `
          <strong>‚úÖ Succ√®s!</strong><br><br>
          ${data.map(r => r.result).join('<br>')}
          <br><br>
          <strong>√âtapes suivantes:</strong><br>
          1. Rafra√Æchissez votre application<br>
          2. Essayez de r√©cup√©rer les commandes<br>
          3. V√©rifiez que tout fonctionne correctement
        `;

      } catch (error) {
        result.className = 'error';
        result.innerHTML = `
          <strong>‚ùå Erreur</strong><br><br>
          ${error.message}
          <br><br>
          <strong>Solutions:</strong><br>
          1. V√©rifiez que vous √™tes connect√© √† Supabase<br>
          2. V√©rifiez que la migration 20251117000007 est appliqu√©e<br>
          3. Utilisez le SQL Editor dans Supabase Dashboard
        `;
      } finally {
        btn.disabled = false;
        btn.innerHTML = 'üöÄ Appliquer TOUS les hotfixes';
      }
    };

    window.applyHotfix = async function(number) {
      const btn = event.target;
      const result = document.getElementById('result');

      btn.disabled = true;
      const originalText = btn.innerHTML;
      btn.innerHTML = '<span class="loading"></span> Application...';
      result.style.display = 'none';

      try {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/rpc/apply_hotfix_20251117000${number}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'apikey': SUPABASE_KEY,
            'Authorization': `Bearer ${SUPABASE_KEY}`
          }
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.message || 'Erreur HTTP ' + response.status);
        }

        const message = await response.json();

        result.className = 'success';
        result.innerHTML = `<strong>${message}</strong>`;

      } catch (error) {
        result.className = 'error';
        result.innerHTML = `<strong>‚ùå Erreur:</strong> ${error.message}`;
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    };
  </script>
</body>
</html>
