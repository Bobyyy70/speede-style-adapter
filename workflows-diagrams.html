<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WMS Speed E-Log - Diagrammes Workflows</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: white;
            border-radius: 15px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            text-align: center;
        }

        h1 {
            color: #667eea;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            font-size: 1.1rem;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        nav {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        nav h3 {
            margin-bottom: 15px;
            color: #667eea;
        }

        nav ul {
            list-style: none;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 10px;
        }

        nav a {
            display: block;
            padding: 10px 15px;
            background: #f8f9fa;
            border-radius: 8px;
            color: #667eea;
            text-decoration: none;
            transition: all 0.3s;
            border-left: 4px solid #667eea;
        }

        nav a:hover {
            background: #667eea;
            color: white;
            transform: translateX(5px);
        }

        .diagram-section {
            background: white;
            border-radius: 15px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .diagram-section h2 {
            color: #667eea;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }

        .diagram-section h3 {
            color: #764ba2;
            margin: 20px 0 10px;
        }

        .diagram-section p {
            color: #666;
            margin-bottom: 20px;
            line-height: 1.8;
        }

        .mermaid {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            overflow-x: auto;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid;
        }

        .alert-info {
            background: #e1f5ff;
            border-color: #0288d1;
            color: #01579b;
        }

        .alert-warning {
            background: #fff4e1;
            border-color: #f57c00;
            color: #e65100;
        }

        .alert-danger {
            background: #ffe1e1;
            border-color: #d32f2f;
            color: #b71c1c;
        }

        .alert-success {
            background: #e1ffe1;
            border-color: #388e3c;
            color: #1b5e20;
        }

        .legend {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .legend h4 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin: 8px 0;
        }

        .legend-color {
            width: 30px;
            height: 30px;
            border-radius: 5px;
            margin-right: 10px;
        }

        footer {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-top: 30px;
            text-align: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 1.8rem;
            }

            .stats {
                grid-template-columns: 1fr;
            }

            nav ul {
                grid-template-columns: 1fr;
            }
        }

        .back-to-top {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #667eea;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transition: all 0.3s;
            text-decoration: none;
            font-size: 1.5rem;
        }

        .back-to-top:hover {
            background: #764ba2;
            transform: translateY(-5px);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìä WMS Speed E-Log</h1>
            <p class="subtitle">Visualisation compl√®te des Workflows & Architecture</p>

            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number">15</div>
                    <div class="stat-label">Workflows Majeurs</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">57</div>
                    <div class="stat-label">Edge Functions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">100+</div>
                    <div class="stat-label">Tables Database</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">200+</div>
                    <div class="stat-label">Actions Distinctes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">95+</div>
                    <div class="stat-label">Pages Frontend</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">164</div>
                    <div class="stat-label">Migrations SQL</div>
                </div>
            </div>
        </header>

        <nav>
            <h3>üìë Navigation Rapide</h3>
            <ul>
                <li><a href="#architecture">1. Architecture Globale</a></li>
                <li><a href="#workflow-e2e">2. Workflow Commande E2E</a></li>
                <li><a href="#sendcloud">3. Sync SendCloud</a></li>
                <li><a href="#technique">4. Architecture Technique</a></li>
                <li><a href="#dependances">5. D√©pendances Workflows</a></li>
                <li><a href="#modules">6. Modules Fonctionnels</a></li>
                <li><a href="#edge-functions">7. Edge Functions</a></li>
                <li><a href="#cycle-vie">8. Cycle de Vie Commande</a></li>
                <li><a href="#sequence">9. S√©quence Cr√©ation Colis</a></li>
                <li><a href="#frontend">10. Modules Frontend</a></li>
                <li><a href="#problemes">11. Probl√®mes Critiques</a></li>
                <li><a href="#roadmap">12. Roadmap Priorit√©s</a></li>
            </ul>
        </nav>

        <section id="architecture" class="diagram-section">
            <h2>1. Architecture Globale du Syst√®me</h2>
            <p>Vue d'ensemble de l'architecture compl√®te du WMS, montrant les interactions entre le frontend React, le backend Supabase, et les int√©grations externes.</p>

            <div class="mermaid">
graph TB
    subgraph "FRONTEND - React + TypeScript"
        A[Client Web/Mobile]
        B[Pages Client]
        C[Pages Gestionnaire]
        D[Pages Admin]
        E[Pages PDA]
    end

    subgraph "BACKEND - Supabase"
        F[PostgreSQL Database<br/>164 Migrations<br/>100+ Tables]
        G[Edge Functions<br/>57 Functions Deno]
        H[Row Level Security<br/>RLS Policies]
        I[Supabase Auth<br/>JWT]
    end

    subgraph "INT√âGRATIONS EXTERNES"
        J[SendCloud API<br/>Transporteurs]
        K[Marketplaces<br/>Amazon, eBay, etc.]
        L[N8N Automation<br/>Workflows]
        M[Mondial Relay API<br/>Points Relais]
        N[FedEx API<br/>Transport]
        O[OpenAI GPT-4<br/>Chatbot IA]
    end

    subgraph "SERVICES"
        P[Email/SMS<br/>Notifications]
        Q[Thermal Printer<br/>√âtiquettes]
        R[Storage<br/>Documents PDF]
    end

    A --> B
    A --> C
    A --> D
    A --> E

    B --> I
    C --> I
    D --> I
    E --> I

    I --> F
    I --> G
    F --> H

    G --> J
    G --> K
    G --> L
    G --> M
    G --> N
    G --> O

    G --> P
    G --> Q
    G --> R

    J -.Webhook.-> G
    K -.Webhook.-> G
    L -.Webhook.-> G
            </div>

            <div class="alert alert-info">
                <strong>‚ÑπÔ∏è Information:</strong> Le syst√®me utilise une architecture moderne serverless avec Supabase comme backend principal, permettant une scalabilit√© automatique et une s√©curit√© renforc√©e via RLS.
            </div>
        </section>

        <section id="workflow-e2e" class="diagram-section">
            <h2>2. Workflow Commande E2E (End-to-End)</h2>
            <p>Cycle de vie complet d'une commande, de la r√©ception √† la livraison finale, incluant tous les points de d√©cision et actions automatis√©es.</p>

            <div class="alert alert-warning">
                <strong>‚ö†Ô∏è Attention:</strong> Ce workflow implique 20+ Edge Functions et 15+ tables diff√©rentes. Toute modification doit √™tre test√©e en profondeur.
            </div>

            <div class="mermaid">
flowchart TD
    Start([Nouvelle Commande]) --> A1{Source?}

    A1 -->|SendCloud| B1[Webhook SendCloud]
    A1 -->|Marketplace| B2[Webhook Marketplace]
    A1 -->|Manuelle| B3[Interface Client]

    B1 --> C[sendcloud-webhook]
    B2 --> C
    B3 --> C

    C --> D[Validation Donn√©es]
    D --> E[Mapping Produits]
    E --> F[Insert DB]
    F --> G[Statut: NOUVEAU]

    G --> H[check-validation-rules]

    H --> I{Validation OK?}

    I -->|Montant √©lev√©| J1[Validation Manuelle]
    I -->|OK| K[approve-commande]

    J1 -->|Approuv√©| K
    J1 -->|Refus√©| END1([Annul√©e])

    K --> L[Statut: VALID√â]
    L --> M[apply-automatic-rules]
    M --> N[R√®gles M√©tier]
    N --> O[apply-automatic-carrier-selection]
    O --> P[S√©lection Transporteur ML]
    P --> Q[Session Picking]
    Q --> R[Wave Picking]
    R --> S[Optimisation Parcours]
    S --> T[PDA: Picking Mobile]
    T --> U[Contr√¥le Qualit√©]
    U --> V[Statut: PR√âPAR√â]
    V --> W[generate-picking-slip]
    W --> X[Zone Exp√©dition]
    X --> Y[Saisie Poids]
    Y --> Z{Export Hors UE?}
    Z -->|Oui| AA[generate-cn23]
    AA --> AB[sendcloud-create-parcel]
    Z -->|Non| AB
    AB --> AC[API SendCloud]
    AC --> AD[Impression √âtiquette]
    AD --> AE[Scan Confirmation]
    AE --> AF[Statut: EXP√âDI√â]
    AF --> AG[Notifications Client]
    AG --> AH[Tracking Temps R√©el]
    AH --> AI{Statut?}
    AI -->|Livr√©| AJ[Statut: LIVR√â]
    AI -->|Exception| AK[Gestion Exception]
    AJ --> AL[analyze-carrier-learning]
    AL --> END2([Termin√©e])
            </div>
        </section>

        <section id="sendcloud" class="diagram-section">
            <h2>3. Workflow Synchronisation SendCloud</h2>
            <p>Processus de synchronisation bidirectionnelle avec SendCloud, incluant l'import initial, la sync continue, et la gestion des webhooks temps r√©el.</p>

            <div class="alert alert-danger">
                <strong>üî¥ Critique:</strong> La sync SendCloud est le c≈ìur du syst√®me. Toute interruption impacte 100% des commandes. CRON configur√© √† 15 minutes.
            </div>

            <div class="mermaid">
flowchart LR
    subgraph "SETUP INITIAL"
        A[sendcloud-initial-setup] --> B[Connexion API]
        B --> C[Webhook Config]
        C --> D1[import-carriers<br/>20-50 transporteurs]
        C --> D2[import-shipping-methods<br/>100-500 services]
        C --> D3[import-senders<br/>1-10 adresses]
        C --> D4[import-products<br/>100-10K produits]
    end

    subgraph "SYNC CONTINUE"
        E[CRON 15min] --> F[sendcloud-sync-orders]
        F --> G[GET /api/v2/parcels]
        G --> H[Rate Limiting 150ms]
        H --> I[Pagination 100/page]
        I --> J[Enrichissement<br/>Max 50/run]
        J --> K[Mapping Produits]
        K --> L[Insert/Update DB]
        L --> M{Erreurs?}
        M -->|Oui| N[Push to DLQ]
        M -->|Non| O[Log Succ√®s]
    end

    subgraph "WEBHOOKS"
        P[SendCloud Webhook] --> Q[sendcloud-webhook]
        Q --> R[Rate Limit<br/>100 req/min]
        R --> S[Validation Zod]
        S --> T[Update Statut]
        T --> U{Succ√®s?}
        U -->|Non| V[DLQ Handler<br/>Retry 5x]
        U -->|Oui| W[200 OK]
    end
            </div>

            <div class="legend">
                <h4>üîÑ Fr√©quences Synchronisation</h4>
                <div class="legend-item">
                    <div class="legend-color" style="background: #e1ffe1;"></div>
                    <span><strong>Setup Initial:</strong> One-time (√† l'installation)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #fff4e1;"></div>
                    <span><strong>Sync Continue:</strong> CRON toutes les 15 minutes</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #e1f5ff;"></div>
                    <span><strong>Webhooks:</strong> Temps r√©el (< 1 seconde)</span>
                </div>
            </div>
        </section>

        <section id="technique" class="diagram-section">
            <h2>4. Architecture Technique D√©taill√©e</h2>
            <p>Stack technique complet du WMS, de la couche pr√©sentation jusqu'√† la base de donn√©es, en passant par les Edge Functions et les services externes.</p>

            <div class="mermaid">
graph TB
    subgraph "CLIENT LAYER"
        A1[Browser Chrome/Firefox/Safari]
        A2[Mobile iOS/Android]
        A3[PDA Zebra/Honeywell]
    end

    subgraph "PRESENTATION LAYER"
        B1[Pages<br/>95+ Pages]
        B2[Components<br/>100+ Composants]
        B3[shadcn/ui + Radix UI]
        B4[TanStack Query]
        B5[React Router v6]
    end

    subgraph "API LAYER"
        C1[REST API PostgREST]
        C2[Realtime WebSocket]
        C3[Auth JWT + RLS]
        C4[Storage S3]
    end

    subgraph "BUSINESS LOGIC"
        D1[Commandes<br/>5 functions]
        D2[SendCloud<br/>29 functions]
        D3[IA/ML<br/>7 functions]
        D4[Documents<br/>4 functions]
        D5[TMS<br/>2 functions]
    end

    subgraph "DATA LAYER"
        E1[PostgreSQL 15<br/>100+ tables]
        E2[RLS Policies]
        E3[Triggers]
        E4[Indexes]
    end

    subgraph "EXTERNAL"
        F1[SendCloud API]
        F2[Marketplaces 40+]
        F3[OpenAI GPT-4]
        F4[Email/SMS]
    end

    A1 --> B1
    A2 --> B1
    A3 --> B1
    B1 --> B2
    B2 --> B3
    B2 --> B4
    B2 --> B5
    B4 --> C1
    B4 --> C2
    C1 --> D1
    C1 --> D2
    C1 --> D3
    D1 --> E1
    D2 --> E1
    D3 --> E1
    E1 --> E2
    E1 --> E3
    D2 --> F1
    D3 --> F3
    F1 -.Webhook.-> D2
            </div>
        </section>

        <section id="dependances" class="diagram-section">
            <h2>5. D√©pendances entre Workflows</h2>
            <p>Graphe de d√©pendances montrant les relations critiques entre les diff√©rents workflows du syst√®me.</p>

            <div class="alert alert-danger">
                <strong>üî¥ D√©pendances Critiques Identifi√©es:</strong>
                <ul style="margin-top: 10px; margin-left: 20px;">
                    <li><strong>Mapping Produits:</strong> sendcloud-sync-orders D√âPEND DE sendcloud_product_mapping (si vide ‚Üí BLOQUANT)</li>
                    <li><strong>Configuration Transporteurs:</strong> apply-automatic-carrier-selection D√âPEND DE transporteur_configuration</li>
                    <li><strong>Client ID:</strong> Toutes pages client D√âPENDENT DE profiles.client_id (80% users sans client_id ‚Üí CRITIQUE)</li>
                </ul>
            </div>

            <div class="mermaid">
graph TD
    subgraph "SETUP"
        A[Import Transporteurs]
        B[Import Services]
        C[Import Exp√©diteurs]
        D[Import Produits]
        E[Config Users & Clients]
    end

    subgraph "SYNC"
        F[Sync Commandes CRON]
        G[Webhooks Temps R√©el]
    end

    subgraph "TRAITEMENT"
        H[Validation Commande]
        I[S√©lection Transporteur]
        J[Pr√©paration Picking]
    end

    subgraph "EXP√âDITION"
        K[Cr√©ation Colis]
        L[G√©n√©ration Documents]
        M[Impression √âtiquettes]
    end

    subgraph "SUIVI"
        N[Tracking Temps R√©el]
        O[Notifications Client]
        P[ML Apprentissage]
    end

    A --> F
    B --> F
    C --> K
    D --> F
    E --> F
    F --> H
    G --> N
    H --> I
    I --> J
    J --> K
    K --> L
    L --> M
    M --> N
    N --> O
    N --> P
    P --> I
            </div>
        </section>

        <section id="modules" class="diagram-section">
            <h2>6. Modules Fonctionnels (Mind Map)</h2>
            <p>Carte mentale des 11 modules fonctionnels principaux du WMS avec leurs sous-fonctionnalit√©s.</p>

            <div class="mermaid">
mindmap
  root((WMS<br/>Speed E-Log))
    STOCK
      R√©ception
      Mouvements
      Inventaire
      Emplacements
      Alertes Rupture
      R√©appro Auto
    COMMANDES
      R√©ception Multi-Sources
      Validation Auto/Manuel
      R√®gles Filtrage
      Kanban Statuts
      D√©cisions Transporteur
    PR√âPARATION
      Wave Picking
      Sessions Picking
      PDA Mobile
      Contr√¥le Qualit√©
      Voice Picking
    EXP√âDITION
      Cr√©ation Colis
      Multi-Transporteurs
      Points Relais
      Douanes CN23
      √âtiquettes Thermiques
    RETOURS
      Portail Client
      Validation Auto
      √âtiquette Retour
      Remise en Stock
      Analytics Retours
    TMS
      Planification Tourn√©es
      Tracking GPS
      Scoring Carriers
      Green Logistics
    IA & ML
      Chatbot GPT-4
      Pr√©dictions Ventes
      Optimisation Co√ªts
      Scoring Fraude
      Apprentissage Continu
    ANALYTICS
      KPIs Temps R√©el
      Dashboards Perso
      Rapports PDF/Excel
      Pr√©dictions ML
    INT√âGRATIONS
      SendCloud API
      40+ Marketplaces
      N8N Automation
      API Publique
    ADMIN
      Gestion Users
      Gestion Clients
      R√®gles Transporteurs
      Audit Trail
    PORTAIL CLIENT
      Dashboard Client
      Mes Commandes
      Cr√©er Commande
      Mes Retours
      Ma Facturation
            </div>
        </section>

        <section id="edge-functions" class="diagram-section">
            <h2>7. Classification des Edge Functions</h2>
            <p>Distribution des 57 Edge Functions selon leur statut d'utilisation.</p>

            <div class="mermaid">
pie title Distribution Edge Functions (57 total)
    "Actives Principales" : 18
    "√Ä Activer" : 10
    "One-Time Setup" : 8
    "√Ä Investiguer" : 5
    "Orphelines/√Ä Supprimer" : 16
            </div>

            <div class="alert alert-warning">
                <strong>‚ö†Ô∏è Attention:</strong> 40% des Edge Functions (16/57) ne sont jamais appel√©es. Cela repr√©sente du code mort qui doit √™tre archiv√© ou activ√©.
            </div>

            <div class="legend">
                <h4>üéØ Actions Recommand√©es</h4>
                <div class="legend-item">
                    <div class="legend-color" style="background: #e1ffe1;"></div>
                    <span><strong>Actives (18):</strong> Continuer monitoring</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #fff4e1;"></div>
                    <span><strong>√Ä Activer (10):</strong> Priorit√© Phase 2-3</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #e1f5ff;"></div>
                    <span><strong>One-Time (8):</strong> Conserver, documenter</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ffe1e1;"></div>
                    <span><strong>√Ä Investiguer (5):</strong> Audit n√©cessaire</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #f8f9fa; border: 2px solid #dee2e6;"></div>
                    <span><strong>Orphelines (16):</strong> Archiver ou supprimer</span>
                </div>
            </div>
        </section>

        <section id="cycle-vie" class="diagram-section">
            <h2>8. Cycle de Vie d'une Commande (State Machine)</h2>
            <p>Diagramme d'√©tats montrant tous les statuts possibles d'une commande et les transitions entre eux.</p>

            <div class="mermaid">
stateDiagram-v2
    [*] --> NOUVEAU: R√©ception<br/>(SendCloud/Marketplace/API)

    NOUVEAU --> EN_ATTENTE_VALIDATION: R√®gles validation KO
    NOUVEAU --> VALID√â: Validation OK

    EN_ATTENTE_VALIDATION --> VALID√â: Gestionnaire approuve
    EN_ATTENTE_VALIDATION --> ANNUL√â: Gestionnaire refuse

    VALID√â --> AVEC_TRANSPORTEUR: S√©lection transporteur

    AVEC_TRANSPORTEUR --> EN_PREPARATION: Cr√©ation session picking

    EN_PREPARATION --> PR√âPAR√â: Picking termin√©

    PR√âPAR√â --> EN_EMBALLAGE: Zone exp√©dition

    EN_EMBALLAGE --> AVEC_√âTIQUETTE: Cr√©ation colis SendCloud

    AVEC_√âTIQUETTE --> EXP√âDI√â: Scan √©tiquette

    EXP√âDI√â --> EN_TRANSIT: Webhook: status changed

    EN_TRANSIT --> EN_LIVRAISON: Webhook: out for delivery

    EN_LIVRAISON --> LIVR√â: Webhook: delivered

    EN_LIVRAISON --> EXCEPTION: Webhook: exception

    EXCEPTION --> EN_TRANSIT: Probl√®me r√©solu
    EXCEPTION --> RETOUR_EXP√âDITEUR: √âchec d√©finitif

    LIVR√â --> [*]: ML apprentissage

    LIVR√â --> RETOUR_DEMAND√â: Client demande retour

    RETOUR_DEMAND√â --> RETOUR_EN_TRANSIT: Client exp√©die
    RETOUR_EN_TRANSIT --> RETOUR_RE√áU: PDA scan retour
    RETOUR_RE√áU --> RETOUR_TRAIT√â: Contr√¥le qualit√©

    RETOUR_TRAIT√â --> [*]: Remboursement

    ANNUL√â --> [*]
    RETOUR_EXP√âDITEUR --> [*]
            </div>

            <div class="alert alert-info">
                <strong>‚ÑπÔ∏è Statuts:</strong> Le syst√®me g√®re 15 statuts diff√©rents avec 25+ transitions possibles. Chaque transition est logg√©e dans transition_commande pour audit.
            </div>
        </section>

        <section id="sequence" class="diagram-section">
            <h2>9. S√©quence Cr√©ation Colis SendCloud</h2>
            <p>Diagramme de s√©quence d√©taill√© montrant les interactions entre tous les acteurs lors de la cr√©ation d'un colis.</p>

            <div class="mermaid">
sequenceDiagram
    actor Op√©rateur
    participant Frontend
    participant EdgeFunction as sendcloud-create-parcel
    participant Supabase as PostgreSQL
    participant SendCloud as SendCloud API
    participant Printer as Thermal Printer
    participant Client as Client

    Op√©rateur->>Frontend: S√©lectionne commande
    Op√©rateur->>Frontend: Saisit poids/dimensions
    Frontend->>Frontend: calculate-volumetric-weight

    Op√©rateur->>Frontend: S√©lectionne transporteur

    alt Export hors UE
        Frontend->>EdgeFunction: generate-cn23
        EdgeFunction->>Supabase: Insert customs_declaration
    end

    Frontend->>EdgeFunction: POST sendcloud-create-parcel

    EdgeFunction->>Supabase: SELECT configuration_expediteur
    Supabase-->>EdgeFunction: Adresse exp√©diteur

    EdgeFunction->>SendCloud: POST /api/v2/parcels
    SendCloud-->>EdgeFunction: parcel_id + tracking + label_url

    EdgeFunction->>Supabase: INSERT parcel_sendcloud
    EdgeFunction->>Supabase: UPDATE commande

    EdgeFunction-->>Frontend: Success + label_url

    Frontend->>Printer: Print label (ZPL/PDF)
    Printer-->>Op√©rateur: √âtiquette imprim√©e

    Op√©rateur->>Frontend: Scan √©tiquette

    Frontend->>Supabase: UPDATE statut='exp√©di√©'

    Frontend->>EdgeFunction: send-carrier-notifications
    EdgeFunction->>Client: Email + SMS Tracking

    Note over Op√©rateur,Client: Temps total: 30-60 secondes
            </div>

            <div class="alert alert-success">
                <strong>‚úÖ Performance:</strong> Le processus complet de cr√©ation colis prend 30-60 secondes en moyenne, incluant l'appel API SendCloud, l'impression, et les notifications.
            </div>
        </section>

        <section id="frontend" class="diagram-section">
            <h2>10. Architecture Modules Frontend</h2>
            <p>Organisation des 95+ pages frontend par modules fonctionnels.</p>

            <div class="mermaid">
graph TB
    subgraph "CLIENT (10 pages)"
        P1[/client/portail]
        P2[/client/commandes]
        P3[/client/commandes/creer]
        P4[/client/produits]
        P5[/client/retours]
    end

    subgraph "COMMANDES (8 pages)"
        P11[/commandes]
        P12[/commandes/central]
        P13[/commandes/preparation]
        P14[/commandes/retours]
    end

    subgraph "STOCK (5 pages)"
        P19[/stock/reception]
        P20[/stock/mouvements]
        P21[/stock/produits]
    end

    subgraph "EXPEDITION (3 pages)"
        P24[/expedition]
        P25[/expedition/preparer]
    end

    subgraph "PDA (6 pages)"
        P27[/pda/]
        P28[/pda/reception]
        P29[/pda/inventaire]
    end

    subgraph "TMS (6 pages)"
        P33[/tms]
        P34[/tms/planification]
        P35[/tms/tracking]
    end

    subgraph "ANALYTICS (4 pages)"
        P39[/analytics]
        P40[/analytics/scoring-predictif]
    end

    subgraph "COMPONENTS"
        C1[shadcn/ui<br/>40+ composants]
        C2[Composants M√©tier<br/>60+ composants]
    end

    P1 --> C1
    P11 --> C1
    P19 --> C1
    P24 --> C1
    P27 --> C1
    P33 --> C1
    P39 --> C1

    C1 --> C2
            </div>
        </section>

        <section id="problemes" class="diagram-section">
            <h2>11. Probl√®mes Critiques Identifi√©s</h2>
            <p>Carte des probl√®mes critiques √† r√©soudre en priorit√©.</p>

            <div class="alert alert-danger">
                <strong>üî¥ URGENT:</strong> 3 probl√®mes critiques de s√©curit√© identifi√©s + 1 probl√®me bloquant donn√©es (80% utilisateurs sans client_id).
            </div>

            <div class="mermaid">
mindmap
  root((Probl√®mes<br/>Critiques))
    S√âCURIT√â üî¥
      Cl√© API N8N hardcod√©e
        Visible c√¥t√© client
        Acc√®s non autoris√© possible
        Solution: Edge Function proxy
      admin-sql expos√©e
        SQL arbitraire
        Faille s√©curit√© majeure
        Solution: Supprimer
    CODE MORT ‚ö†Ô∏è
      40% Edge Functions orphelines
        16 functions jamais appel√©es
        Co√ªts inutiles
        Solution: Audit + Archivage
      Tables orphelines
        ia_conversation non utilis√©e
        Solution: DROP ou migration
    FONCTIONNALIT√âS üü°
      RelayPointSelector mock√©e
        Points relais factices
        Solution: API SendCloud r√©elle
      ChatbotIA non rout√©e
        437 lignes inaccessible
        Solution: Ajouter route
    DONN√âES üî¥
      80% users sans client_id
        RLS bloque acc√®s
        Pages vides clients
        Solution: Assignation masse
      Mapping produits incomplet
        Sync commandes √©choue
        Solution: Import initial
            </div>
        </section>

        <section id="roadmap" class="diagram-section">
            <h2>12. Roadmap Priorit√©s (Gantt)</h2>
            <p>Planning prioris√© des corrections et am√©liorations sur 6 semaines.</p>

            <div class="mermaid">
gantt
    title Roadmap Corrections & Am√©liorations
    dateFormat  YYYY-MM-DD

    section Phase 1: S√âCURIT√â
    S√©curiser cl√© N8N           :crit, sec1, 2025-01-20, 2d
    S√©curiser admin-sql         :crit, sec2, after sec1, 1d
    Audit cl√©s API              :crit, sec3, after sec2, 2d
    Tests s√©curit√©              :crit, sec4, after sec3, 2d

    section Phase 2: DONN√âES
    Assignation client_id       :crit, data1, 2025-01-21, 2d
    Import mapping produits     :crit, data2, after data1, 1d
    V√©rification RLS            :crit, data3, after data2, 2d

    section Phase 3: FONCTIONNALIT√âS
    Router ChatbotIA            :feat1, 2025-01-27, 1d
    RelayPointSelector API      :feat2, after feat1, 2d
    Toggle automation           :feat3, after feat2, 1d
    Activer DLQ handler         :feat4, after feat3, 2d

    section Phase 4: NETTOYAGE
    Audit Edge Functions        :clean1, 2025-02-03, 3d
    Archiver functions          :clean2, after clean1, 2d
    Nettoyer console.log        :clean3, after clean2, 2d

    section Phase 5: PERFORMANCE
    Optimiser sync SendCloud    :perf1, 2025-02-10, 3d
    Corriger queries N+1        :perf2, after perf1, 2d

    section Phase 6: ML
    Activer ML functions        :ml1, 2025-02-17, 4d
    Entra√Ænement mod√®les        :ml2, after ml1, 3d
            </div>

            <div class="alert alert-info">
                <strong>üìÖ Timeline:</strong> Roadmap sur 6 semaines avec focus prioritaire sur la s√©curit√© (Phase 1) et les donn√©es critiques (Phase 2).
            </div>
        </section>

        <footer>
            <h3>üìä R√©sum√© Global</h3>
            <p>Ce document pr√©sente une visualisation compl√®te de l'architecture WMS Speed E-Log avec :</p>
            <ul style="text-align: left; max-width: 600px; margin: 20px auto;">
                <li>‚úÖ 15 workflows majeurs document√©s</li>
                <li>‚úÖ 57 Edge Functions classifi√©es</li>
                <li>‚úÖ 100+ tables et leurs relations</li>
                <li>‚úÖ 95+ pages organis√©es par modules</li>
                <li>‚úÖ D√©pendances critiques identifi√©es</li>
                <li>‚úÖ Probl√®mes visualis√©s clairement</li>
                <li>‚úÖ Roadmap prioris√©e sur 6 semaines</li>
            </ul>
            <p style="margin-top: 30px; color: #666;">
                <strong>Document g√©n√©r√© le:</strong> 2025-11-20<br/>
                <strong>Version:</strong> 1.0<br/>
                <strong>Auteur:</strong> Claude (Anthropic)<br/>
                <strong>Projet:</strong> Speede Style Adapter - WMS
            </p>
        </footer>
    </div>

    <a href="#" class="back-to-top" title="Retour en haut">‚Üë</a>

    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default',
            securityLevel: 'loose',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            }
        });

        // Smooth scroll
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            });
        });

        // Back to top button
        const backToTop = document.querySelector('.back-to-top');
        window.addEventListener('scroll', () => {
            if (window.pageYOffset > 300) {
                backToTop.style.display = 'flex';
            } else {
                backToTop.style.display = 'none';
            }
        });
    </script>
</body>
</html>
